<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fiche m√©dicale</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#f8f9fb; --card:#fff; --text:#0f172a; --muted:#475569; --accent:#2563eb; --ok:#16a34a;
      --shadow:0 6px 24px rgba(0,0,0,.08);
      --radius:20px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1020; --card:#0f1426; --text:#eef2ff; --muted:#9aa3b2; --accent:#60a5fa; --shadow:0 6px 24px rgba(0,0,0,.4); }
    }
    html,body{margin:0;height:100%;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    body{background:var(--bg);color:var(--text);display:flex;align-items:center;justify-content:center;padding:24px;}
    .wrap{width:min(820px,100%);display:grid;gap:18px;}
    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:24px 22px;
    }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
    }
    h1{font-size:28px; margin:0;}
    .badge{font-size:12px; color:#fff; background:var(--accent); padding:6px 10px; border-radius:999px; letter-spacing:.2px;}
    .grid{display:grid; gap:12px; grid-template-columns: 1fr 1fr;}
    .item{background:transparent; border:1px solid rgba(148,163,184,.25); border-radius:14px; padding:14px 16px;}
    .label{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; margin-bottom:6px;}
    .value{font-size:16px; line-height:1.35; word-break:break-word;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius:12px; padding:10px 14px; border:1px solid rgba(148,163,184,.25); text-decoration:none; color:var(--text);
    }
    .btn.primary{ background:var(--accent); border-color:transparent; color:#fff; }
    .btn.safe{ background:var(--ok); border-color:transparent; color:#fff; }
    .muted{color:var(--muted);}
    .disclaimer{font-size:12px; color:var(--muted);}
    .section-title{font-size:18px; margin:8px 0 2px;}
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } body{padding:16px;} }
    @media print{
      body{background:#fff;}
      .card{box-shadow:none; border:1px solid #e5e7eb;}
      .no-print{display:none!important;}
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="header">
        <h1>Fiche m√©dicale</h1>
        <span id="badge" class="badge">En ligne</span>
      </div>

      <div class="grid" id="grid">
        <!-- Rempli dynamiquement -->
      </div>

      <div class="row no-print" style="margin-top:14px">
        <a id="callPrimary" class="btn primary" href="#" aria-label="Appeler le contact d'urgence principal">üìû Appeler le contact d‚Äôurgence</a>
        <a id="smsPrimary" class="btn" href="#" aria-label="Envoyer un SMS au contact d'urgence principal">üí¨ SMS</a>
        <a class="btn" href="javascript:window.print()" aria-label="Imprimer cette fiche">üñ®Ô∏è Imprimer</a>
        <span class="muted mono" id="idSpan"></span>
      </div>

      <p class="disclaimer" style="margin-top:10px">
        Ces donn√©es sont fournies par la personne concern√©e. En cas d‚Äôurgence, composez les services d‚Äôurgence locaux.
      </p>
    </section>
  </main>

  <script>
    // R√©cup√®re l'ID depuis l'URL: /m/<id> (ex: /m/exemple-123)
    const pathParts = location.pathname.split('/').filter(Boolean);
    const id = pathParts[pathParts.length - 1] || 'exemple-123';
    document.getElementById('idSpan').textContent = 'ID: ' + id;

    // Option simple: data √† ../data/<id>.json
    const dataURL = `../data/${encodeURIComponent(id)}.json`;

    // S√©curit√© basique: emp√™che indexation + supprime referrer
    const metaRef = document.createElement('meta');
    metaRef.name = 'referrer';
    metaRef.content = 'no-referrer';
    document.head.appendChild(metaRef);

    function field(label, value, options={}) {
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `
        <div class="label">${label}</div>
        <div class="value">${value ? value : '<span class="muted">‚Äî</span>'}</div>
      `;
      if (options.cols === 2) el.style.gridColumn = '1 / -1';
      return el;
    }

    function asText(v){
      if (Array.isArray(v)) return v.filter(Boolean).join(', ');
      if (v == null) return '';
      return String(v);
    }

    function telLink(num){
      const clean = (num||'').replace(/\s+/g,'');
      return clean ? `tel:${clean}` : '#';
    }

    function smsLink(num, message='Urgence ‚Äî ce message a √©t√© g√©n√©r√© depuis votre fiche m√©dicale.'){
      const clean = (num||'').replace(/\s+/g,'');
      const body = encodeURIComponent(message);
      return clean ? `sms:${clean}?&body=${body}` : '#';
    }

    async function load(){
      try{
        const res = await fetch(dataURL, {cache:'no-store'});
        if(!res.ok) throw new Error('Fiche introuvable');
        const d = await res.json();

        const grid = document.getElementById('grid');
        grid.append(
          field('Nom et pr√©nom', asText(d.nom)),
          field('Adresse', asText(d.adresse), {cols:2}),
          field('Num√©ro de t√©l√©phone', asText(d.telephone)),
          field('Groupe sanguin', asText(d.groupe_sanguin)),
          field('Allergies', asText(d.allergies), {cols:2}),
          field('Traitements', asText(d.traitements), {cols:2}),
          field('Liste des m√©dicaments', asText(d.medicaments), {cols:2}),
          field('Contact d‚Äôurgence ‚Äî nom', asText(d.urgence?.nom)),
          field('Contact d‚Äôurgence ‚Äî t√©l√©phone', asText(d.urgence?.telephone))
        );

        // Boutons d'action
        const primary = d.urgence?.telephone || d.telephone;
        document.getElementById('callPrimary').href = telLink(primary);
        document.getElementById('smsPrimary').href  = smsLink(primary);

        // Indicateur "√† jour" si timestamp r√©cent
        if (d.last_update){
          const badge = document.getElementById('badge');
          const dt = new Date(d.last_update);
          badge.textContent = 'Mise √† jour : ' + dt.toLocaleDateString();
        }
      }catch(e){
        const grid = document.getElementById('grid');
        const el = document.createElement('div'); el.className='item';
        el.style.gridColumn='1 / -1';
        el.innerHTML = `<div class="value">‚ùå Fiche introuvable pour l‚ÄôID ¬´ ${id} ¬ª.</div>`;
        grid.append(el);
      }
    }
    load();
  </script>
</body>
</html>
